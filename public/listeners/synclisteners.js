
/*!
 * Sync Listeners, v0.1
 *
 * Copyright (c) 2013 Dave Olsen, http://dmolsen.com
 * Licensed under the MIT license
 *
 * The JavaScript component of the WebSocket set-up that supports syncing
 * navigation between browsers and content updates with the server.
 *
 * The WebSocket test is from Modernizr. It might be a little too strict for our purposes.
 * https://github.com/Modernizr/Modernizr/blob/master/feature-detects/websockets.js
 *
 */

var wsn;
var wsnConnected = false;
var wsc;
var wscConnected = false;
var dataPrevious = 0;
var host = window.location.host;

// handle page updates from one browser to another
function connectNavSync() {

	if ('WebSocket' in window && window.WebSocket.CLOSING === 2) {
		
		wsn = new WebSocket("ws://"+host+":"+navSyncPort+"/navsync");
		
		// when trying to open a connection to WebSocket update the pattern lab nav bar
		wsn.onopen = function (event) {
			wsnConnected = true;
			$('#navSyncButton').attr("data-state","on");
			$('#navSyncButton').addClass("connected");
			$('#navSyncButton').html('Nav Sync On');
		}
		
		// when closing a connection (or failing to make a connection) to WebSocket update the pattern lab nav bar
		wsn.onclose = function (event) {
			wsnConnected = false;
			$('#navSyncButton').attr("data-state","off");
			if ($('#navSyncButton').hasClass("connected")) {
				$('#navSyncButton').removeClass("connected");
			}
			$('#navSyncButton').html('Nav Sync Disabled');
		}
		
		// when receiving a message from WebSocket update the iframe source
		wsn.onmessage = function (event) {
			$sgViewport.attr('src',event.data+'?'+dataPrevious);
		}
		
		// when there's an error update the pattern lab nav bar
		wsn.onerror = function (event) {
			wsnConnected = false;
			$('#navSyncButton').attr("data-state","off");
			if ($('#navSyncButton').hasClass("connected")) {
				$('#navSyncButton').removeClass("connected");
			}
			$('#navSyncButton').html('Nav Sync Disabled');
		}
		
	}
	
}
connectNavSync();

// handle content updates generated by the watch
function connectContentSync() {
	
	if ('WebSocket' in window && window.WebSocket.CLOSING === 2) {
		
		var dc = true;
		wsc = new WebSocket("ws://"+host+":"+contentSyncPort+"/contentsync");
		
		// when trying to open a connection to WebSocket update the pattern lab nav bar
		wsc.onopen = function (event) {
			wscConnected = true;
			$('#contentSyncButton').attr("data-state","on");
			$('#contentSyncButton').addClass("connected");
			$('#contentSyncButton').html('Content Sync On');
		}
		
		// when closing a connection (or failing to make a connection) to WebSocket update the pattern lab nav bar
		wsc.onclose = function (event) {
			wscConnected = false;
			$('#contentSyncButton').attr("data-state","off");
			if ($('#contentSyncButton').hasClass("connected")) {
				$('#contentSyncButton').removeClass("connected");
			}
			$('#contentSyncButton').html('Content Sync Disabled');
		}
		
		// when receiving a message from WebSocket check to see if the payload is different than previous
		// if so reload the iframe
		wsc.onmessage = function (event) {
			
			if (dc !== false) {
				if (event.data != dataPrevious) {
					$sgViewport.attr('src',$sgViewport.attr('src')+'?'+event.data);
					dataPrevious = event.data;
				}
			} else {
				dc = true;
				dataPrevious = event.data;
			}
		
		}
		
		// when there's an error update the pattern lab nav bar
		wsc.onerror = function (event) {
			wscConnected = false;
			$('#contentSyncButton').attr("data-state","off");
			if ($('#contentSyncButton').hasClass("connected")) {
				$('#contentSyncButton').removeClass("connected");
			}
			$('#contentSyncButton').html('Content Sync Disabled');
		}
		
	}
	
}
connectContentSync();

// handle when a user manually turns navSync and contentSync on & off
$('#navSyncButton').click(function() {
	if ($(this).attr("data-state") == "on") {
		wsn.close();
		$(this).attr("data-state","off");
		$(this).removeClass("connected");
		$(this).html('Nav Sync Off');
	} else {
		connectNavSync();
		$(this).attr("data-state","on");
		$(this).addClass("connected");
		$(this).html('Nav Sync On');
	}
});

$('#contentSyncButton').click(function() {
	if ($(this).attr("data-state") == "on") {
		wsc.close();
		$(this).attr("data-state","off");
		$(this).removeClass("connected");
		$(this).html('Content Sync Off');
	} else {
		connectContentSync();
		$(this).attr("data-state","on");
		$(this).addClass("connected");
		$(this).html('Content Sync On');
	}
});
